<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.yusys.yscimc.myorder.repository.mapper.LoyAcOrderListMapperApp">
	<!-- 获取用户可使用票券 -->
	<select id="getAvailableTicket" parameterType="String" resultType="java.util.HashMap">
		SELECT T.ORDER_NUMBER,T.ORDER_STATE,R.TICKET_NO,Y.TICKET_NAME,Y.USE_CONDITION,
		Y.USE_REMARK,M.MERCHANT_NAME,S.USED_STS,S.VIRT_NO,S.VIRT_PWD,M.MERCHANT_LOGO,
		to_char(U.VALID_START_DATE,'yyyy-mm-dd') as valid_start_date,
		to_char(U.VALID_END_DATE,'yyyy-mm-dd') as valid_end_date
		FROM LOY_AC_ORDER_LIST T 
		LEFT JOIN LOY_AC_ORDER_OUT_LIST R ON T.ORDER_NUMBER = R.ORDER_NUMBER 
		LEFT JOIN LOY_QY_VIRT_STOCK S ON R.VIRT_NO = S.VIRT_NO
		LEFT JOIN LOY_QY_VIRT_TICKET Y ON R.TICKET_NO = Y.TICKET_NO
		LEFT JOIN LOY_QY_VIRT_BATCH U ON Y.TICKET_NO = U.TICKET_NO 
		LEFT JOIN LOY_QY_MERCHANT_INFO M ON Y.MERCHANT_NO = M.MERCHANT_ID
		WHERE T.COMMODITY_TYPE = 'V' AND U.VALID_END_DATE <![CDATA[>=]]> SYSDATE 
		AND T.ORDER_CUST_ID = #{custId,jdbcType=VARCHAR} AND S.USED_STS = '3'
	</select>
	
	<!-- 获取用户已使用票券 -->
	<select id="getUsedTicket" parameterType="String" resultType="java.util.HashMap">
		SELECT T.ORDER_NUMBER,T.ORDER_STATE,R.TICKET_NO,Y.TICKET_NAME,Y.USE_CONDITION,
		Y.USE_REMARK,M.MERCHANT_NAME,S.USED_STS,S.VIRT_NO,S.VIRT_PWD,M.MERCHANT_LOGO,
		to_char(U.VALID_START_DATE,'yyyy-mm-dd') as valid_start_date,
		to_char(U.VALID_END_DATE,'yyyy-mm-dd') as valid_end_date 
		FROM LOY_AC_ORDER_LIST T 
		LEFT JOIN LOY_AC_ORDER_OUT_LIST R ON T.ORDER_NUMBER = R.ORDER_NUMBER 
		LEFT JOIN LOY_QY_VIRT_STOCK S ON R.VIRT_NO = S.VIRT_NO
		LEFT JOIN LOY_QY_VIRT_TICKET Y ON R.TICKET_NO = Y.TICKET_NO
		LEFT JOIN LOY_QY_VIRT_BATCH U ON Y.TICKET_NO = U.TICKET_NO 
		LEFT JOIN LOY_QY_MERCHANT_INFO M ON Y.MERCHANT_NO = M.MERCHANT_ID
		WHERE T.COMMODITY_TYPE = 'V' AND T.ORDER_CUST_ID = #{custId,jdbcType=VARCHAR} 
		AND S.USED_STS = '2'
	</select>
	
	<!-- 获取用户过期票券 -->
	<select id="getExpiredTicket" parameterType="String" resultType="java.util.HashMap">
		SELECT T.ORDER_NUMBER,T.ORDER_STATE,R.TICKET_NO,Y.TICKET_NAME,Y.USE_CONDITION,
		Y.USE_REMARK,M.MERCHANT_NAME,M.MERCHANT_LOGO,
		to_char(U.VALID_START_DATE,'yyyy-mm-dd') as valid_start_date,
		to_char(U.VALID_END_DATE,'yyyy-mm-dd') as valid_end_date 
		FROM LOY_AC_ORDER_LIST T 
		LEFT JOIN LOY_AC_ORDER_OUT_LIST R ON T.ORDER_NUMBER = R.ORDER_NUMBER 
		LEFT JOIN LOY_QY_VIRT_TICKET Y ON R.TICKET_NO = Y.TICKET_NO
		LEFT JOIN LOY_QY_VIRT_BATCH U ON Y.TICKET_NO = U.TICKET_NO 
		LEFT JOIN LOY_QY_MERCHANT_INFO M ON Y.MERCHANT_NO = M.MERCHANT_ID
		WHERE T.COMMODITY_TYPE = 'V' AND T.ORDER_CUST_ID = #{custId,jdbcType=VARCHAR} 
		AND U.VALID_END_DATE <![CDATA[<]]> SYSDATE
	</select>
	
	<!-- 用户核销虚拟票券 -->
	<update id="checkUsedTicket" parameterType="String">
		UPDATE LOY_QY_VIRT_STOCK SET USED_STS = '2' WHERE VIRT_NO = #{virtNo,jdbcType=VARCHAR}
	</update>
	
	<!-- 查询主订单 -->
	<select id="getParentOrder" parameterType="java.util.Map" resultType="java.util.HashMap">
		SELECT T.ORDER_STATE,T.CONSIGNEE_NAME,T.CONSIGNEE_NUMBER,T.CONSIGNEE_ADDRESS,
		DECODE(T.MAJOR_ORDER_NUMBER,NULL,T.ORDER_NUMBER,T.MAJOR_ORDER_NUMBER) AS MAJOR_ORDER_NUMBER,
		DECODE(COUNT(T.ORDER_NUMBER),NULL,0,COUNT(T.ORDER_NUMBER)) AS ORDER_NUM,
    	DECODE(TO_CHAR(T.ORDER_START_DATE,'YYYY-MM-DD'),NULL,TO_CHAR(SYSDATE,'YYYY-MM-DD'),TO_CHAR(T.ORDER_START_DATE,'YYYY-MM-DD')) AS ORDER_DATE,
    	DECODE(TO_CHAR(T.ORDER_START_DATE,'HH:MI:SS'),NULL,TO_CHAR(SYSDATE,'HH:MI:SS'),TO_CHAR(T.ORDER_START_DATE,'HH:MI:SS')) AS ORDER_TIME,
		DECODE(SUM(T.COMMODITY_L_VALUE),NULL,0,SUM(T.COMMODITY_L_VALUE)) AS TOTAL_SCORE 
		FROM LOY_AC_ORDER_LIST T 
		WHERE T.ORDER_CUST_ID = #{orderCustId,jdbcType=VARCHAR} AND T.COMMODITY_TYPE = 'R'
		<if test="orderState != 0">
		AND T.ORDER_STATE = #{orderState,jdbcType=VARCHAR}
		</if>
		GROUP BY T.CONSIGNEE_NAME,T.CONSIGNEE_NUMBER,T.CONSIGNEE_ADDRESS,T.ORDER_STATE,
		DECODE(T.MAJOR_ORDER_NUMBER,NULL,T.ORDER_NUMBER,T.MAJOR_ORDER_NUMBER),
		DECODE(TO_CHAR(T.ORDER_START_DATE,'YYYY-MM-DD'),NULL,TO_CHAR(SYSDATE,'YYYY-MM-DD'),TO_CHAR(T.ORDER_START_DATE,'YYYY-MM-DD')),
    	DECODE(TO_CHAR(T.ORDER_START_DATE,'HH:MI:SS'),NULL,TO_CHAR(SYSDATE,'HH:MI:SS'),TO_CHAR(T.ORDER_START_DATE,'HH:MI:SS'))
	</select>
	
	<!-- 查询子订单(商品图片为商品缩略图) -->
	<select id="getSonOrder" parameterType="java.util.Map" resultType="java.util.HashMap">
		SELECT U.PICTURE_PATH,R.COMMODITY_NAME,T.MODEL_PARAM,R.COMMODITY_L_VALUE,
		COUNT(R.COMMODITY_CODE) AS BUY_NUM,SUM(R.COMMODITY_L_VALUE) AS TOTAL_VALUE
		FROM LOY_AC_ORDER_LIST T
		LEFT JOIN LOY_QY_COMMODITY_INFO R ON R.COMMODITY_CODE = T.COMMODITY_CODE
		LEFT JOIN LOY_QY_COMM_MODEL Y ON Y.COMMODITY_CODE = R.COMMODITY_CODE
		LEFT JOIN LOY_QY_COMM_PICTURE U ON U.COMMODITY_CODE = R.COMMODITY_CODE
		WHERE U.PICTURE_TYPE = '01'
		AND (T.MAJOR_ORDER_NUMBER = #{majorOrderNumber,jdbcType=VARCHAR} OR T.ORDER_NUMBER = #{majorOrderNumber,jdbcType=VARCHAR})
		GROUP BY U.PICTURE_PATH,R.COMMODITY_NAME,T.MODEL_PARAM,R.COMMODITY_L_VALUE
	</select>
	
	<!-- 订单确认收货 -->
	<update id="orderConfirmReceive" parameterType="java.util.Map">
		UPDATE LOY_AC_ORDER_LIST SET ORDER_STATE = '5' 
		WHERE MAJOR_ORDER_NUMBER = #{majorOrderNumber,jdbcType=VARCHAR} OR ORDER_NUMBER = #{majorOrderNumber,jdbcType=VARCHAR}
	</update>
	
	<!-- 订单换货 -->
	<update id="orderExchangeGood" parameterType="java.util.Map">
		UPDATE LOY_AC_ORDER_LIST SET ORDER_STATE = '4',ORDER_EXC_REASON = #{orderExcReason,jdbcType=VARCHAR}
		WHERE ORDER_NUMBER = #{orderNumber,jdbcType=VARCHAR}
	</update>
</mapper>